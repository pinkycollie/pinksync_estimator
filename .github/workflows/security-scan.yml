# Security Scanning Workflow with Taskade Sync
# MBTQ.dev Ecosystem - Deaf-First Security Automation

name: "Security Scan & Taskade Sync"

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6 AM UTC
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - npm
          - python
          - trivy

env:
  TASKADE_WEBHOOK: https://www.taskade.com/webhooks/01KAZEPCKA9B3QG8CJ4XF6J69S

jobs:
  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'npm' || github.event.inputs.scan_type == '' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run npm audit
        continue-on-error: true
        run: |
          npm audit --json > npm-audit.json 2>&1 || true
          echo "NPM audit completed"

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: npm-audit.json
          retention-days: 30

      - name: Send results to Taskade
        if: always()
        run: |
          pip3 install requests
          python3 scripts/taskade-security-sync.py parse --type npm --file npm-audit.json

  python-security:
    name: Python Security (Bandit)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'python' || github.event.inputs.scan_type == '' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        continue-on-error: true
        run: |
          # Scan Python files if they exist
          if find . -name "*.py" -type f | head -1 | grep -q .; then
            bandit -r . -f json -o bandit-report.json --exclude ./.venv,./node_modules,./dist || true
          else
            echo '{"results": [], "metrics": {"_totals": {"loc": 0}}}' > bandit-report.json
          fi
          echo "Bandit scan completed"

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        with:
          name: bandit-results
          path: bandit-report.json
          retention-days: 30

      - name: Send results to Taskade
        if: always()
        run: |
          pip3 install requests
          python3 scripts/taskade-security-sync.py parse --type bandit --file bandit-report.json

  trivy-scan:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'trivy' || github.event.inputs.scan_type == '' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true

      - name: Upload Trivy results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.json
          retention-days: 30

      - name: Send results to Taskade
        if: always()
        run: |
          pip3 install requests
          python3 scripts/taskade-security-sync.py parse --type trivy --file trivy-results.json

  security-summary:
    name: Security Summary & Taskade Sync
    runs-on: ubuntu-latest
    needs: [npm-audit, python-security, trivy-scan]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: scan-results

      - name: List downloaded artifacts
        run: |
          echo "üìÅ Downloaded scan results:"
          find scan-results -type f -name "*.json" | head -20

      - name: Install dependencies
        run: pip3 install requests

      - name: Send combined summary to Taskade
        env:
          TASKADE_WEBHOOK: ${{ env.TASKADE_WEBHOOK }}
        run: |
          # Collect all result files
          FILES=""
          
          if [ -f "scan-results/npm-audit-results/npm-audit.json" ]; then
            FILES="${FILES}scan-results/npm-audit-results/npm-audit.json,"
          fi
          
          if [ -f "scan-results/bandit-results/bandit-report.json" ]; then
            FILES="${FILES}scan-results/bandit-results/bandit-report.json,"
          fi
          
          if [ -f "scan-results/trivy-results/trivy-results.json" ]; then
            FILES="${FILES}scan-results/trivy-results/trivy-results.json,"
          fi
          
          # Remove trailing comma
          FILES="${FILES%,}"
          
          if [ -n "$FILES" ]; then
            echo "üìä Sending combined summary for: $FILES"
            python3 scripts/taskade-security-sync.py summary --files "$FILES"
          else
            echo "‚ö†Ô∏è No scan results found"
          fi

      - name: Create security summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary = '## üîí Security Scan Summary\n\n';
            summary += '| Scanner | Status |\n';
            summary += '|---------|--------|\n';
            
            const scanners = [
              { name: 'NPM Audit', file: 'scan-results/npm-audit-results/npm-audit.json' },
              { name: 'Bandit (Python)', file: 'scan-results/bandit-results/bandit-report.json' },
              { name: 'Trivy', file: 'scan-results/trivy-results/trivy-results.json' }
            ];
            
            for (const scanner of scanners) {
              try {
                if (fs.existsSync(scanner.file)) {
                  summary += `| ${scanner.name} | ‚úÖ Completed |\n`;
                } else {
                  summary += `| ${scanner.name} | ‚è≠Ô∏è Skipped |\n`;
                }
              } catch (e) {
                summary += `| ${scanner.name} | ‚ùì Unknown |\n`;
              }
            }
            
            summary += '\nüì§ Results synced to Taskade\n';
            summary += `\nüîó [View workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
